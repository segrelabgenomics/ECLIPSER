## README

This repository contains the scripts and instructions for running ECLIPSER (Enrichment of Causal Loci and Identification of Pathogenic cells in Single Cell Expression and Regulation data).

ECLIPSER tests whether the expression of genes mapped to GWAS loci of complex diseases or traits, based on eQTLs/sQTLs and other functional data, are enriched in specific cell types in one or more tissues.

Authors: Jiali Wang, John Rouhana, written in the Segre lab under the guidance of Ayellet Segre, Massachusetts Eye and Ear, Harvard Medical School, Boston, MA

Contributors to code: Andrew Hamel, Brian Cole, Massachusetts Eye and Ear, Harvard Medical School

Last updated: November 24, 2021

## Repository structure
`src`: the directory contains scripts for the software pipeline and for plotting results with relevant instructions

`data`: the directory contains input files required to run ECLIPSER

`examples`: sample data for running ECLIPSER on snucRNA-seq data from GTEx tissues, broad cell type annotations and 21 complex diseases/traits whose pathophysiology is related to any of these tissues.

## Dependencies
ECLIPSER was written in Python (> 3.6) and requires the following libraries and modules:

- pandas 1.1.3
- numpy 1.18.1
- matplotlib 3.3.1
- seanborn 0.11.0
- statsmodels 0.11.1
- plotnine 0.8.0

## Running Environment and Run Time
We recommend to reserve ~60GB of memory when running the clumping step in ECLIPSER and ~1 GB when running the enrichment step. 

- The estimated run time for generating clumping files for the GWAS loci of a given trait (for example atrial fibrillation) and the null set of GWAS loci is ~30 minutes. 

- The estimated run time for performing enrichment analysis for a given trait in one tissue for 13 cell types (for example atrial fibrillation in Heart) is ~3 minutes. 

## Instructions on how to run ECLIPSER

### A. Data preparation and preprocessing

(1) Generate file with list of trait(s) of interest and all traits whose pathophysiology is related to the tested tissue that will be removed from the null set of GWAS variants, and the GWAS names that correspond to these traits as found in the GWAS catalog that will be used (Default: Open Targets Genetics, but can also use NHGRI-EBI GWAS catalog), in the following format:

Tab-delimited text file without header, each row corresponding to a different trait, and with the first column being the generic name of the trait of interest (no spaces), and the following columns the GWAS names that map to the given trait, as found in the GWAS variant resource used (Default: Open Targets Genetics, but one can use other databases such as the NHGRI-EBI GWAS catalog).

If you want to use a custom GWAS for your trait of interest, you will need to prepare a list of genome-wide significant GWAS variants for the trait(s) of interest and run it through GWASvar2gene as described below, and concatenate it with the full set of GWAS variants from Open Targets or GWAS catalog.

Example files:
`/data/GTEx_traits/`
`/data/Reynolds_etal_skin_traits/`

(2) Prepare gene differential expression statistics table (e.g., using Welch's t-test, Wilcoxon rank sum test, MAST method)
Required columns with headers: ‘celltype’, ‘gene’, ‘tissue’, ‘pvals_fdr’, ‘log2FC’
Optional column: 'pct.1' (% cells expressing gene in given cell type)

Example files can be downloaded from Zenodo with accompanying files for Eraslan et al. BioRxiv 2021 and Rouhana, Wang et al. BioRxiv 2021:
`GTEx_snRNAseq_DGE_broad_cell_types.csv`
`skin_normal_final_clustering_DGE_Reynolds_etal_Science2021.csv`

(3) Optional: You can download the following (large) input data files generated by the tool GWASvar2gene (see below) that contain the gene to GWAS variant mapping for all GWAS variants in Open Targets Genetics (from July 2020) from Zenodo (used in Eraslan et al., BioRxiv 2021 and Rouhana, Wang et al., BioRxiv 2021), or generate them by applying GWASvar2gene to your table of GWAS variants as described in section B:

GWASvar2gene_open_targets_trait_table.tsv, GWASvar2gene_open_targets_proxy_table.tsv, GWASvar2gene_open_targets_eQTL_table.tsv, GWASvar2gene_open_targets_sQTL_table.tsv, opentargets_variant_and_gene_table.tsv

### B. Map genes to GWAS loci using GWASvar2gene tool

GWASvar2gene takes as input list of variants associated with one or mutiple traits, and maps genes to the variants based on the target genes of eQTLs or sQTLs that are in linkage disequilibrium to the GWAS variant.
GWASvar2gene can be downloaded from: https://github.com/segrelabgenomics/GWASvar2gene

See GWASvar2gene README for instructions on how to run on your list of GWAS variants. It should be run on GWAS variants of traits of interest and a background set of GWAS variants of unrelated traits (e.g., all variants in NHGRI-EBI GWAS catalog or Open Targets Genetics).

This step is required to generate a table with LD proxy variants for all GWAS variants of traits of interest and all other traits (null set), as it is used for the GWAS locus clumping step in ECLIPSER. We provide such a file for all GWAS variants from Open Targets Genetics (NHGRI-EBI GWAS catalog and UK Biobank GWAS downloaded on 2020) that can be downloaded from Zenodo.

### C. Perform LD clumping of GWAS variants with 'clumping.py'

GWAS variants that share LD proxy variants or mapped eGenes or sGenes are collapsed into a single locus. This is done separately for the GWAS variants for each selected trait and for all null traits per tissue.

#### Example shell script to run clumping.py for each trait and tissue combinations:

Shell script run on skin diseases and traits analyzed in Rouhana, Wang et al., BioRxiv 2021 using skin snRNA-seq from Reynolds et al., Science 2021:
`clumping_skin_traits.sh`

Shell script applied to 21 complex traits and diseases using 8 GTEx snRNA-seq data from Eraslan et al., BioRxiv 2021:
`clumping_GTEx_tissues.sh'

#### Required inputs:

--proxy_table
Path to GWASVar2Gene LD proxy table (e.g., GWASvar2gene_open_targets_proxy_table.tsv). Must include columns named ‘GWAS_variant’ and ‘LD_variant’. 

--traits_table
Path to GWASVar2Gene traits table (e.g., GWASvar2gene_open_targets_trait_table.tsv). Must include columns named ‘GWAS_variant’, ‘trait’, ‘GWAS_p_value’, ‘Sample_Ancestries’. 

--eQTL_table
Path to GWASVar2Gene eQTL_table (e.g., GWASvar2gene_open_targets_eQTL_table.tsv). Must include columns named ‘GWAS_variant’, ‘gene_id’, ‘gene_name’, ‘eVariant’.

--sQTL_table
Path to GWASVar2Gene sQTL_table (e.g., GWASvar2gene_open_targets_sQTL_table.tsv). Must include columns named ‘GWAS_variant’, ‘gene_id’, ‘gene_name’, ‘sVariant’.

Note: Variant IDs should match between all tables. We use the following variant ID format used in GTEx: CHR_POS_REF_ALT_GENOMEBUILD (e.g., chr1_196731921_G_C_b38)

--significant_traits

Tab delimited text file (one row per trait), with the first column the generic name of the trait of interest and the following columns the 
GWAS trait names that map to the generic trait name. GWAS trait names (2-n columns) should match the trait column in traits_table exactly.
(sample files in: /data/GTEx_traits/)

-out_directory
Directory where output files will be written. Defaults to working directory.

#### Optional inputs:
--opentarget
Path to Open Targets Genetics file (e.g., opentargets_variant_and_gene_table.tsv). Must include columns named ‘variant_id’, ‘bestLocus2Genes’.

--ancestry
Case insensitive string regex indicating what ancestry to look for in GWAS, for example ‘Eur’. All GWAS not including string are excluded.

-treat_sig_traits_as_one
If a string is given, all significant/selected traits will be treated as a single trait under this shared trait name.

#### Outputs:

For each tissue 

• \[generic_trait_name]_consolidated_clumping.tsv 

where genetric_trait_name are the trait names in the first column of the significant_traits file. There are three columns: the first column contains the clumped GWAS loci of the generic trait of interest; if there are multiple GWAS variants mapped to a single locus, they are separated by comma. All LD proxy variants are included in the clumped GWAS locus irrespective of whether it is a significant GWAS variant. The second column contains the genes mapped to the GWAS locus from the first column; if there are multiple mapped genes, they are separated by comma. The third column is the source of the mapped gene(s) (eGene/sGene/Open Targets bestLocus2Genes, denoted as e/s/o, respectively). The order of the source is the same as the order of genes in the second column.

•	Null_consolidated_clumping.tsv
The same as above except, just that this is for the background set of GWAS variants. 

#### Example Outputs:
`/example/GTEx_clumping_files`
`/example/Skin_clumping_files`

### D. Perform GWAS enrichment analysis with 'enrichment.py'

The significance of a GWAS locus set cell type specificity score per cell type is assessed against the distribution of values of the background GWAS loci using a Bayesian Fisher’s exact test or permutation approach.

#### Example shell script to run enrichment.py for each trait, tissue, and cell type combination:

Shell script run on skin diseases and traits analyzed in Rouhana, Wang et al., BioRxiv 2021 using skin snRNA-seq from Reynolds et al., Science 2021:
`/src/enrichment_skin_traits.sh`

Shell script applied to 21 complex traits and diseases and 8 GTEx snRNA-seq data analyzed in Eraslan et al., BioRxiv 2021:
`/src/enrichment_GTEx_tissues.sh`

#### Required inputs:
--sc_path

Path to the comma delimited single cell differential expression table (should be .csv file). Must include columns named ‘celltype’, ‘gene’, ‘tissue’, ‘pvals_fdr’, ‘log2FC’.
Optional column: 'pct.1' (% cells expressing gene in given cell type)

--clumps_file
Path to the LD clumping files of trait(s) of interest from GWAS clumping output.

Example files under example/

--background_file
Path to the LD clumping file of background traits from GWAS clumping output.

--trait
Name of trait of interest.

--tissue 
Name of the tissue being tested with single cell/nucleus expression data. Should match the values in the tissue column in the --sc_path input file.

--out_directory
Directory where output files will be written. Default to working directory.

--num_samples
Number of Monte Carlo sampling that each run should take. Default: 1,000,000.

--cutoff1
Cutoff value of log2FC (‘log2FC’ column in DGE table). Default: 0.5.

--cutoff2
Cutoff value of FDR (‘pvals_fdr’ column in DGE table). Default: 0.1.

--cutoff3
Cutoff value of % cells expressing gene in given cell type ('pct.1' column in DGE table). Default: 0.05.

--method
Enrichment analysis method, Bayesian or Permutation. Default: Bayesian.

#### Outputs:
For each tissue and trait of interest:

Table_[trait]_\[tissue].csv

Columns include: ‘Cell type’, ‘Fold-enrichment lower 95% CI’, ‘Fold-enrichment’, ‘Fold- enrichment upper 95% CI’, ‘Enrichment p-value’, ‘BH adj. Enrichment p-value (tissue-wide)’, ‘Average GWAS locus set statistic’, ‘Fraction of GWAS loci >95% percentile of null loci’, ‘Leading edge genes’, ‘Leading edge GWAS loci’, ‘Leading edge genes source’, ‘GWAS’, ‘Tissue’


### E. Generate figures and summary tables

#### Python notebook:
Example on GTEx tissues:
`/src/Tables_figures_GTEx_Eraslan_etal_BioRxiv2021.ipynb`

Example on Reynolds et al Skin snRNA-seq data:
`/src/Tables_figures_skin_Reynolds_etal.ipynb`

#### GWAS traits table
Each row is a trait. Columns include the counts of starting number of GWAS variants ('GWAS_variants'), GWAS loci after LD clumping ('GWAS_loci'), GWAS loci after LD clumping that have one or more mapped genes ('GWAS_loci'), GWAS PMID/study ID ('GWAS').

#####  Example Output:
`/example/trait_GWAS_table.csv`

#### Enrichment table (Main table of ECLIPSER cell-type enrichment results across all traits and tissues)
Concatenate enrichment result tables of each trait and tissue pair into a single table. 
Each row is a trait, tissue, cell type combination. Columns include: 'GWAS', 'Tissue', 'Cell type', 'Enrichment p-value','BH adj. Enrichment p-value (tissue-wide)', 'BH adj. Enrichment P-value (Experiment-wide)', 'Fold-enrichment', 'Fold-enrichment lower 95% CI', 'Fold-enrichment upper 95% CI', 'Average GWAS locus set statistic','Fraction of GWAS loci >95% percentile of null loci', 'Leading edge genes', 'Num of leading edge genes', 'Leading edge genes source', 'Leading edge GWAS loci', 'Num of leading edge GWAS loci'.

Leading edge GWAS loci are the loci whose cell type specificity score passes the 95th percentile of the null loci scores. Leading edge genes are the cell type-specific genes that fall in the leading edge GWAS loci.

#####  Example Output:
`/example/GWAS_enrichment_table.tsv`

#### Forest plot
Forest plot of fold-enrichment of all cell types for a given trait and tissue, sorted by fold-enrichment and colored by significance level.

#####  Example Output:
`/example/forest_plot_Heart_Atrial_fibrillation.png`

#### Heatmap of tissue by cell types and GWAS
Heatmap of fold-enrichment of tissue by cell types and traits based on hierarchical clustering. Tissue/cell type and trait pairs with nominal p-value < 0.05 are annotated with an asterisk.

#####  Example Output:
`/example/heatmap.png`

#### Enrichment bubble map

Bubble map of enrichment results of traits by cell types, facet by tissues. The color of the circles is proportional to the fold-enrichment and the size is proportional to -log10 of the enrichment p-value. Circles with nominal, tissue-wide, and experimental-wide significant results are surrounded by grey, orange and red rings respectively.

#####  Example Output:
`/example/bubblemap.png`

#### Leading-edge genes plot (plot of fold-change of the cell type-specific genes in GWAS loci that pass the 95th percentile enrichment cutoff that are driving the enrichment signal in a particular cell type)
log2 fold-change of the leading-edge genes in a trait, tissue and cell type of interest (red points). log2 fold-change of the same genes from other tissues can be overlaid, with grey lines indicating genes with log2 fold-change above a given cutoff (e.g., 0.5) and FDR below a given cutoff (e.g., 0.1) in all tissues plotted, and pink lines indicating cell type specific genes that are specific to the user defined tissue of interest.

#####  Example Output:
`/example/leading_edge_genes.png`

## If you use this tool please cite:

John M. Rouhana*, Jiali Wang*, Gokcen Eraslan, Shankara Anand, Andrew R. Hamel, Brian Cole, Aviv Regev, François Aguet, Kristin G. Ardlie, and Ayellet V. Segrè. ECLIPSER: identifying causal cell types and genes for complex traits through single cell enrichment of e/sQTL-mapped genes in GWAS loci. BioRxiv, 2021. *Co-first authors. 

Gokcen Eraslan*, Eugene Drokhlyansky*, Ayshwarya Subramanian**, Shankara Anand**, Evgenij Fiskin**, Michal Slyper**, Jiali Wang**,  Nicholas Van Wittenberghe, John Rouhana, Julia Waldman, Orr Ashenberg, Danielle Dionne, Thet Su Win, Michael S. Cuoco, Olena Kuksenko, Philip A. Branton, Jamie L. Marshall, Anna Greka, Gaddy Getz, Ayellet V. Segrè#, François Aguet#, Orit Rozenblatt-Rosen#, Kristin Ardlie#, Aviv Regev#. Single-nucleus cross-tissue molecular reference maps to decipher disease gene function. bioRxiv 2021, https://www.biorxiv.org/content/10.1101/2021.07.19.452954v1. Under review at Science. *Co-first authors, **Co-second authors, #Co-senior authors and Co-corresponding authors.
doi: https://doi.org/10.1101/2021.07.19.452954
